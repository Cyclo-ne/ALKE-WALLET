<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Enviar Dinero - Alke Wallet</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h2 class="mb-4">Enviar Dinero</h2>

      <!-- Buscador de contactos -->
      <div class="card mb-3">
        <input
          type="text"
          id="busquedaContactos"
          class="form-control mb-3"
          placeholder="Buscar contacto..."
        />
        <ul
          id="agendaContactos"
          class="list-group list-group-flush"
          style="max-height: 170px; overflow-y: auto"
        >
          <!--*Revisar color de boton matias S. -->
          <li class="list-group-item contacto">Maria Gonzalez</li>
          <li class="list-group-item contacto">Matias Segovia</li>
          <li class="list-group-item contacto">Leonardo Paredes</li>
        </ul>
      </div>

      <!-- Formulario de envío -->
      <div class="card mb-3">
        <form id="formEnviar">
          <input
            type="text"
            id="destinatario"
            class="form-control mb-3"
            placeholder="Destinatario"
            readonly
            required
          />
          <input
            type="number"
            id="montoEnviar"
            class="form-control mb-4"
            placeholder="Monto $"
            required
          />
          <button type="submit" class="btn btn-primary w-100 py-3">
            Confirmar Envío
          </button>
        </form>
      </div>

      <div id="alertaEnviar" class="mt-3"></div>

      <a href="menu.html" class="btn btn-outline-secondary w-100 mt-2"
        >Volver</a
      >
    </div>

    <footer class="footer">Desarrollado por R.Jorquera</footer>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#busquedaContactos").on("input", function () {
          const filtro = $(this).val().toLowerCase();
          $("#agendaContactos .contacto").each(function () {
            const nombre = $(this).text().toLowerCase();
            $(this).toggle(nombre.includes(filtro));
          });
        });

        $("#agendaContactos").on("click", ".contacto", function () {
          $("#agendaContactos .contacto").removeClass("active");
          $(this).addClass("active");
          $("#destinatario").val($(this).text());
        });

        $("#formEnviar").submit(function (e) {
          e.preventDefault();

          const monto = parseFloat($("#montoEnviar").val());
          const saldo = parseFloat(localStorage.getItem("walletBalance")) || 0;
          const destinatario = $("#destinatario").val();

          if (!destinatario) {
            $("#alertaEnviar").html(
              '<div class="alert alert-danger text-center mt-2">Selecciona un destinatario</div>'
            );
            return;
          }

          if (monto > 0 && monto <= saldo) {
            const nuevoSaldo = saldo - monto;
            localStorage.setItem("walletBalance", nuevoSaldo.toFixed(2));

            let historial =
              JSON.parse(localStorage.getItem("walletTransactions")) || [];
            historial.unshift({
              tipo: `Envío a ${destinatario}`,
              monto: -monto,
              fecha:
                new Date().toLocaleDateString() +
                " " +
                new Date().toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                }),
            });
            localStorage.setItem(
              "walletTransactions",
              JSON.stringify(historial)
            );

            $("#alertaEnviar").html(`
                    <div class="alert alert-success text-center mt-2">
                        Envío de $${monto.toLocaleString()} a ${destinatario} realizado
                    </div>
                `);

            setTimeout(() => (window.location.href = "menu.html"), 1500);
          } else {
            $("#alertaEnviar").html(
              '<div class="alert alert-danger text-center mt-2">Saldo insuficiente</div>'
            );
          }
        });
      });
    </script>
  </body>
</html>
